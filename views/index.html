<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.0/css/bootstrap.min.css"
          integrity="sha384-SI27wrMjH3ZZ89r4o+fGIJtnzkAnFs3E4qz9DIYioCQ5l9Rd/7UAa8DHcaL8jkWt" crossorigin="anonymous">
    <link rel="stylesheet" href="/static/css/styles.css">
    <title>å¾…åŠäº‹é¡¹åˆ—è¡¨</title>
    <style>
        .edit-mode {
            display: none;
        }
        .editing .edit-mode {
            display: inline-block;
        }
        .editing .view-mode {
            display: none;
        }
    </style>
</head>

<body style="background-color: #FEF2F2;">
    <div>
        <div style="
            display: flex;
            align-items: center;
            margin-left: 20px;
            margin-top: 20px;
        ">
            <a href="/home" style="
                display: inline-block;
                padding: 10px 20px;
                background-color: #DC2626;
                color: white;
                font-weight: 600;
                border-radius: 6px;
                text-decoration: none;
                text-align: center;
                transition: all 0.3s ease;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                font-size: 16px;
            ">è®¿é—®å®˜æ–¹ç½‘ç«™</a>
        </div>
    </div>

    <div class="container">
        <h2 style="
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #DC2626;
            font-size: 24px;
        ">å¾…åŠäº‹é¡¹åˆ—è¡¨</h2>
        <div class="card">
            <div class="card-header">æ·»åŠ ä»»åŠ¡</div>
            <div class="card-body">
                <form action="/add" method="post">
                    <div class="form-group">
                        <label for="Item">é¡¹ç›®</label>
                        <input type="text" class="form-control" name="item" placeholder="ä½ æƒ³åšä»€ä¹ˆï¼Ÿ">
                        <small class="form-text text-muted">è¾“å…¥ä½ æƒ³ç¨åå¤„ç†çš„äº‹æƒ… ğŸ™‚</small>
                    </div>
                    <button type="submit" class="btn btn-primary">æäº¤</button>
                </form>
            </div>
        </div>
    </div>
    &nbsp;
    &nbsp;
    <div class="container">
        <div class="card">
            <div class="card-header">ä»»åŠ¡åˆ—è¡¨</div>
            <div class="card-body">
                <div id="message-area" style="display: none;" class="alert"></div> <!-- ADD THIS LINE -->
                <table class="table table-borderless">
                    <thead>
                    <tr>
                        <th scope="col">é¡¹ç›®</th>
                        <th scope="col">æ›´æ–°æ—¶é—´</th>
                        <th scope="col">çŠ¶æ€</th>
                        <th scope="col">æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody>
                    {{range .Todos}}
                        {{if .Completed}}
                            <tr>
                                <td><strike>{{.Item}}</strike></td>
                                <td>{{.FormatUpdatedAt}}</td>
                                <td>å·²å®Œæˆ</td>
                                <td>
                                    <button class="btn btn-primary" disabled>å®Œæˆ</button>
                                    <button class="btn btn-danger" disabled>åˆ é™¤</button>
                                </td>
                            </tr>
                        {{else}}
                            <tr data-id="{{ .Id}}">
                                <td>
                                    <span class="view-mode">{{.Item}}</span>
                                    <div class="edit-mode">
                                        <input type="text" class="form-control todo-edit-input" value="{{.Item}}">
                                    </div>
                                </td>
                                <td>{{.FormatUpdatedAt}}</td>
                                <td>å¾…å¤„ç†</td>
                                <td>
                                    <div class="view-mode">
                                        <a href="/complete/{{ .Id}}"><button class="btn btn-primary">å®Œæˆ</button></a>
                                        <button class="btn btn-warning edit-btn" onclick="handleEdit({{ .Id}})">ç¼–è¾‘</button>
                                        <a href="/delete/{{ .Id}}"><button class="btn btn-danger">åˆ é™¤</button></a>
                                    </div>
                                    <div class="edit-mode">
                                        <button class="btn btn-success save-btn" onclick="saveEdit({{ .Id}})">ä¿å­˜</button>
                                        <button class="btn btn-secondary cancel-btn" onclick="cancelEdit({{ .Id}})">å–æ¶ˆ</button>
                                    </div>
                                </td>
                            </tr>
                        {{end}}
                    {{end}}
                    </tbody>
                </table>
                
                <!-- åˆ†é¡µå¯¼èˆª -->
                {{if gt .Pagination.TotalPages 1}}
                <nav aria-label="Todoåˆ—è¡¨åˆ†é¡µ">
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="pagination-info">
                            <small class="text-muted">
                                å…± {{.Pagination.TotalRecords}} æ¡è®°å½•ï¼Œå½“å‰ç¬¬ {{.Pagination.CurrentPage}}/{{.Pagination.TotalPages}} é¡µ
                            </small>
                        </div>
                        <ul class="pagination pagination-sm mb-0">
                            <!-- ä¸Šä¸€é¡µ -->
                            {{if .Pagination.HasPrevious}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page={{.Pagination.PreviousPage}}" aria-label="ä¸Šä¸€é¡µ">
                                        <span aria-hidden="true">&laquo;</span> ä¸Šä¸€é¡µ
                                    </a>
                                </li>
                            {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link" aria-label="ä¸Šä¸€é¡µ">
                                        <span aria-hidden="true">&laquo;</span> ä¸Šä¸€é¡µ
                                    </span>
                                </li>
                            {{end}}
                            
                            <!-- ç¬¬ä¸€é¡µ -->
                            {{if gt .Pagination.CurrentPage 1}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page=1">1</a>
                                </li>
                            {{end}}
                            
                            <!-- çœç•¥å· -->
                            {{if gt .Pagination.CurrentPage 3}}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {{end}}
                            
                            <!-- å½“å‰é¡µçš„å‰ä¸€é¡µ -->
                            {{if gt .Pagination.CurrentPage 2}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page={{.Pagination.PreviousPage}}">{{.Pagination.PreviousPage}}</a>
                                </li>
                            {{end}}
                            
                            <!-- å½“å‰é¡µ -->
                            <li class="page-item active">
                                <span class="page-link">{{.Pagination.CurrentPage}}</span>
                            </li>
                            
                            <!-- å½“å‰é¡µçš„åä¸€é¡µ -->
                            {{if lt .Pagination.CurrentPage .Pagination.TotalPages}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page={{.Pagination.NextPage}}">{{.Pagination.NextPage}}</a>
                                </li>
                            {{end}}
                            
                            <!-- çœç•¥å· -->
                            {{if and (gt .Pagination.TotalPages 3) (lt .Pagination.CurrentPage .Pagination.TotalPages)}}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {{end}}
                            
                            <!-- æœ€åä¸€é¡µ -->
                            {{if and (gt .Pagination.TotalPages 1) (lt .Pagination.CurrentPage .Pagination.TotalPages)}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page={{.Pagination.TotalPages}}">{{.Pagination.TotalPages}}</a>
                                </li>
                            {{end}}
                            
                            <!-- ä¸‹ä¸€é¡µ -->
                            {{if .Pagination.HasNext}}
                                <li class="page-item">
                                    <a class="page-link" href="/?page={{.Pagination.NextPage}}" aria-label="ä¸‹ä¸€é¡µ">
                                        ä¸‹ä¸€é¡µ <span aria-hidden="true">&raquo;</span>
                                    </a>
                                </li>
                            {{else}}
                                <li class="page-item disabled">
                                    <span class="page-link" aria-label="ä¸‹ä¸€é¡µ">
                                        ä¸‹ä¸€é¡µ <span aria-hidden="true">&raquo;</span>
                                    </span>
                                </li>
                            {{end}}
                        </ul>
                    </div>
                </nav>
                {{end}}
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Track the current editing row
        let currentEditingId = null;

        // Handle edit button click
        function handleEdit(id) {
            // Cancel any previous edit in progress
            if (currentEditingId !== null && currentEditingId !== id) {
                cancelEdit(currentEditingId);
            }

            // Set current editing id
            currentEditingId = id;

            // Toggle edit mode for the row
            const row = document.querySelector(`tr[data-id="${id}"]`);
            row.classList.add('editing');

            // Focus on the input field
            const input = row.querySelector('.todo-edit-input');
            input.focus();

            // Position cursor at the end of the text
            const inputLength = input.value.length;
            input.setSelectionRange(inputLength, inputLength);

            // Add event listeners for keyboard input
            input.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    saveEdit(id);
                }
            });

            // Add event listener for clicking outside
            document.addEventListener('click', handleOutsideClick);
        }

        // Handle save button click
        function saveEdit(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const newValue = row.querySelector('.todo-edit-input').value.trim();

            // Don't save empty values
            if (newValue === '') {
                cancelEdit(id);
                return;
            }

            const messageArea = document.getElementById('message-area');
            
            // Show loading indicator
            messageArea.textContent = 'Saving... Please wait.';
            messageArea.className = 'alert alert-info';
            messageArea.style.display = 'block';

            // Make AJAX request to update the todo
            fetch(`/todos/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item: newValue
                }),
            })
            .then(async response => {
                if (response.ok) {
                    messageArea.textContent = 'Saved successfully! Reloading...';
                    messageArea.className = 'alert alert-success';
                    // Add a small delay before refreshing to allow server processing and message visibility
                    setTimeout(() => {
                        window.location.reload();
                    }, 500); // 500ms delay
                } else {
                    let errorMsg = 'Failed to update todo item, please try again.';
                    try {
                        // Attempt to get a more specific error message from the server response
                        const errorData = await response.json();
                        if (errorData && errorData.error) {
                            errorMsg = errorData.error;
                        }
                    } catch (e) {
                        // If response is not JSON or other parsing error, use the generic message
                        console.warn('Could not parse error response JSON:', e);
                    }
                    console.error('Failed to update todo, status:', response.status);
                    messageArea.textContent = errorMsg;
                    messageArea.className = 'alert alert-danger';
                    messageArea.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error during fetch operation:', error);
                messageArea.textContent = 'An unexpected error occurred. Please check your connection and try again.';
                messageArea.className = 'alert alert-danger';
                messageArea.style.display = 'block';
            });
        }

        // Handle cancel button click
        function cancelEdit(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);

            // Reset input value to original text
            const originalText = row.querySelector('.view-mode').textContent;
            row.querySelector('.todo-edit-input').value = originalText;

            // Hide message area on cancel
            const messageArea = document.getElementById('message-area');
            messageArea.style.display = 'none';

            // Exit edit mode
            row.classList.remove('editing');
            currentEditingId = null;

            // Remove the outside click handler
            document.removeEventListener('click', handleOutsideClick);
        }

        // Handle clicks outside the editing area
        function handleOutsideClick(event) {
            if (currentEditingId !== null) {
                const row = document.querySelector(`tr[data-id="${currentEditingId}"]`);
                const clickedInsideRow = row.contains(event.target);

                // If click is outside the row being edited
                if (!clickedInsideRow) {
                    // Check if the click was on the message area
                    const messageArea = document.getElementById('message-area');
                    const clickedInsideMessageArea = messageArea.contains(event.target);

                    // Cancel edit only if the click is outside the row AND outside the message area
                    if (!clickedInsideMessageArea) {
                         cancelEdit(currentEditingId);
                    }
                }
            }
        }
    </script>
</body>
</html>